<!doctype html>
<html>
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
<title>LSGUI Code Editor</title>

<head>
<!-- //TEMPORARY: just to aid in development workflow -->
<!-- <meta http-equiv="refresh" content="5; URL=http://localhost:8080"> -->
<!--        SOURCES         -->
<!-- Codemirror -->
    <!-- styles -->

    <link rel=stylesheet href="cm/docs.css">
    <link rel=stylesheet href="cm/codemirror.css">
    <link rel=stylesheet href="cm/addons/fullscreen/fullscreen.css">
    <link rel=stylesheet href="cm/one-dark.css">



    <!-- <link rel=stylesheet href="cm/merge.css">
    <link rel=stylesheet href="cm/icecoder.css"> -->

    <!-- scripts -->
    <script src="cm/codemirror.js"></script>
    <script src="cm/css.js"></script>
    <!-- load local server version if cdn unavailable -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script><script>if (!window.jQuery) document.write('<script src="cm/diff_match_patch.js"><\/script>');</script> -->

    <!-- <script src="cm/htmlmixed.js"></script> -->
    <!-- <script src="cm/xml.js"></script> -->
    <!-- <script src="cm/merge.js"></script> -->
    <!-- <script src="cm/modes/javascript.js"></script> -->
    <script src="cm/modes/clike.js"></script>
    <script src="cm/modes/glsl.js"></script>
    <script src="cm/modes/python.js"></script>
    <script src="cm/addons/buttons/buttons.js"></script>
  <script src="cm/addons/panel.js"></script>
  <script src="cm/addons/fullscreen/fullscreen.js"></script>
  <script src="cm/cm-resize.js"></script>


<!-- General Sources -->
    <!-- style -->
    <link rel=stylesheet href="css/jquery-ui.css">

    <!-- <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->

    <link rel=stylesheet href="css/cards.css">
    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/jquery-ui.js"></script>

    <!-- resizeable columns -->
    <!-- <link rel=stylesheet href="css/colresizeable.css"> -->

    <!-- <script src="js/colResizable-1.5.min.js"></script> -->

    <script src="js/jquery.mousewheel.js"></script>

    <!-- server address & open/close -->

</head>

<style>

.cm-highlight {color: lightgreen; background-color: green}
.cm-highlight-lastLine {color: rgb(144, 182, 238); background-color: rgb(0, 102, 128)}
.CodeMirror-selection-highlight-scrollbar {background-color: green}

/* <!-- rgb(39, 174, 96)
rgb(142, 68, 173)
rgb(218, 247, 166)
rgb(255, 195, 0)
rgb(255, 87, 51)
rgb(199, 0, 57) --> */
/* .cm {
    width:200px;
   	margin:auto;
    font-size:14px;
    border:1px solid #000;
    border-collapse:collapse; }

.cm td {
    color:#000099;
    vertical-align:middle;
    text-align:left;
    border:1px solid #000;
    height: 100% } */

/* .stateParams {

} */
</style>


<button id="writesourceCode">Save</button>
<button id="clearHighlights">Clear Highlighting</button>
<div id="source" height="100%"></div> 
<script>

var bodySize = [document.body.clientWidth, document.body.clientHeight]
var ws_url;
// var worktreeList;
// var history;
var ws;
var ws_url = "ws://" + window.location.host;
//the alicenode state:
var state = [];
var lines = []
var lastLine;


// document.getElementById('server').value = ws_url;



/////////////////// WEBSOCKET STUFF

var ws;
function ws_connect(opt) {
	ws = new WebSocket(opt.transport+'://'+opt.host+':'+opt.port, opt.protocols);
	ws.binaryType = 'arraybuffer';
	ws.onerror = opt.onerror;
	ws.onopen = opt.onopen;
	ws.onmessage = opt.onmessage;
	ws.onclose = function(e) {
		ws = null;
		setTimeout(function(){
			console.log("websocket reconnecting...");
			ws_connect(opt);
		}, 2000);		
		opt.onclose(e);
	}
	return ws;
}

ws_connect({
	transport: "ws",
	host: "localhost",
	port: "8080",
	protocols: [],
	onerror: function() {},
	onclose: function(e) { console.log('websocket closed', e.code); },
	onopen: function() {
		console.log('websocket opened');
		// once connected, request the current scene:
		// ws.send(JSON.stringify({
		// 	type: "get_ast",
		// 	date: Date.now()
		// }));
	},
	onmessage: function(e) { 
		if (e.data instanceof ArrayBuffer) {
			console.log("ws received arraybuffer of " + e.data.byteLength + " bytes");
		} else {
			try {
        // console.log(e)
				var msg = JSON.parse(e.data);
				// console.log("ws received JSON", msg);
				handleMessage(msg);
			} catch (e) {
				console.log('ws bad JSON: ', e);
			}
		} 
		// //Example code: send a binary blob:
		// const array = new Float32Array(5);
		// for (var i = 0; i < array.length; ++i) {
		// 	array[i] = i / 2;
		// }
		// ws.send(array);
	},
});

var cppSource; // this must be global

function handleMessage(msg) {
	switch (msg.type) {
    case "source":

    sourceCode = JSON.parse(msg.value)
    stateCode(sourceCode)

    break;
/*
		case "set_ast": 
			// update whole scene based on msg.value
			// console.log(msg.value);
			let ast = msg.value;
			cppSource = msg.value.files;
			let files = Object.keys(cppSource) // set list of files
			filePicker(files) // update the file list in the filepicker menu
			cpp2CodeMirror(cppSource[Object.keys(cppSource)[1]], $("#codeView")); //put the cpp code in codemirror
			
			$("#tree").children().remove(); // clear the tree
			ast2html(ast, $("#tree"), ast); // decorate the tree...
			

		break;
		case "git":
		console.log(msg.hash)
		hash = msg.hash.split(" ")[0]
		time = new Date(msg.date).toUTCString()

		console.log(time)
		
		commitMsg = msg.hash.replace(/^\S+/g, '')
		entry = time + " " + commitMsg
		var sel = document.getElementById('sessionHistorySelect')

			var opt = document.createElement('option')
			opt.appendChild(document.createTextNode(entry))
			opt.value = hash
			sel.appendChild(opt)
		break;

		case "update": 
			
			updatedAST = JSON.stringify(msg.value.diagnostics)
			//console.log("update\n" + updatedAST)

			msg.value.diagnostics.forEach(function (item) {
				console.log('line ' + item.loc.begin.line + ': ' + item.kind);
				//console.log(item.loc);

				//console.log(item.severity);

				var sel = document.getElementById('astErrorSelect')
				var opt = document.createElement('option')
				opt.appendChild(document.createTextNode('line ' + item.loc.begin.line + ': ' + item.kind))
				opt.value = item.loc.begin.line
				sel.appendChild(opt)

			})


			


			

			// updatedAST.diagnostics.forEach(function (item) {
			// 	console.log(item)
			// })


			
		
    break;
    */

	}
}

function selectHash(select){
	e = document.getElementById(select)
  var hash = e.options[e.selectedIndex].value
  // console.log(selectedBranch)
	//ws.send('selectedBranch?' + selectedBranch)
	console.log(hash)
	ws.send(JSON.stringify({
		type: "show",
		date: Date.now(),
		hash: hash,
		filename: filename
	}));
}

// fill the codemirror instance with source code
function stateCode(stateCode) {
    if (stateCode == null) return;
    var target = document.getElementById("source");
    target.innerHTML = "";
    dv = CodeMirror(target, {
        value: stateCode,
        styleActiveLine: true,
        lineNumbers: true,
        mode: "python",
        theme: 'one-dark',
        readOnly: false,
        //NOTE: viewportMargin, when set to 'infinity', allows for full text searching, BUT when set to a high number seems to have been the source of the sluggishness in the client app!! so now its only at 10. 
        viewportMargin: 10,
        revertButtons: true,
        allowEditingOriginals: true,
        linewrapping: true,
        undoDepth: 200,
        cursorBlinkRate: 300,
        cursorScrollMargin: 0,                   
    });
    dv.setSize("100%", 550);
}

jQuery(document).keydown(function(event) {
        // If Control or Command key is pressed and the S key is pressed
        // run save function. 83 is the key code for S.
        if((event.ctrlKey || event.metaKey) && event.which == 83) {
            // Save Function
            event.preventDefault();
            writeSourceCode();
            return false;
        }
    }
);

// write new state.h to disk and commit changes
$(function() {
    $("#writesourceCode").click(function(){
      writeSourceCode()
    });
});

// save

function writeSourceCode()
        {
            //console.log(line)
        writesourceCode = {};

        // authorName = "Graham Wakefield"
        // authorEmail = "grrrwaaa@gmail.com"
        newSource = dv.getValue()

        var changeMsg = prompt('Please provide a comment about your changes', 'reticulating splines')
        // writesourceCode = {newSource, changeMsg}
        // ws.send('updateCode' + JSON.stringify(writesourceCode))

        ws.send(JSON.stringify({
          type: "update",
          date: Date.now(),
          sourceCode: newSource,
          message: changeMsg
        }));

        // console.log(writesourceCode)           
    }

function updateState(paramName, paramValue){

// Update the state.bin server-side ///////////////////////
//the server needs to know what type each parameter is so it can pass it to the correct buffer write
var paramType;
Object.keys(state).forEach(function(key, value) {
    if (paramName === state[key].paramName) {
        paramType = state[key].type
    }                     
})
//update the state.bin server-side
let stateUpdate = [];
ws.send("stateUpdate?" + paramName + " " + paramValue + " " + paramType)

// ///////////////////////////////////////////////////
// provide line highlighting for in the codemirror editor so user can easily spot parameters 
// in the state.h file:
// get the begin-end lines of each parameter within the state.h!
Object.keys(state).forEach(function(key, value) {
    pName = state[key].paramName;
    begin = state[key].begin - 1;
    end = state[key].end;
    // tell codemirror to highlight the chosen line
    if (pName == paramName){
        // if the parameter is different from previous change, highlight previously modified parameter as blue in the state.h
        if (lastLine !== undefined && lastLine !== begin) {
            dv.addLineClass(lastLine, 'background', 'cm-highlight-lastLine');
        }
        // if new parameter change, tell cm where to highlight
        var t = dv.charCoords({line: begin, ch: 0}, "local").top; 
        var middleHeight = dv.getScrollerElement().offsetHeight / 2; 
        // focus the editor's page around the line
        dv.scrollTo(null, t - middleHeight - 5);
        // apply highlight to the selected parameter-line
        dv.addLineClass(begin, 'background', 'cm-highlight');
        // set the cm cursor to the line
        dv.setCursor({line: begin, ch: window.lastpo});
        // remember the current selected line for next time we change a param
        lastLine = begin;
    }
}) 
}

//// clear highlights
$(function() {
$("#clearHighlights").click( function()
    {
    Object.keys(lines).forEach(function(key, value) {
    console.log(lines[key].begin)
    dv.removeLineClass(lines[key].begin, 'background');

    });
});

})


</script>


</body>
</html>